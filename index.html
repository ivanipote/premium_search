<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recherche Intelligente ‚Ä¢ Megane Learn</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs" type="module"></script>
  <style>
    /* === STYLES G√âN√âRAUX === */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f9ff 0%, #e8f2ff 100%);
      min-height: 100vh;
    }

    /* === LOGO HEADER CENTR√â === */
    .header-center {
      text-align: center;
      padding: 30px 20px 20px;
      background: white;
      box-shadow: 0 4px 20px rgba(0,102,255,0.1);
    }

    .logo-container {
      display: inline-flex;
      align-items: center;
      gap: 15px;
      background: white;
      padding: 15px 40px;
      border-radius: 50px;
      border: 4px solid #0066FF;
      box-shadow: 0 8px 30px rgba(0,102,255,0.2);
    }

    .logo-header {
      height: 50px;
      width: auto;
    }

    .logo-text {
      font-size: 2.2rem;
      font-weight: bold;
      color: #0066FF;
      letter-spacing: -0.5px;
    }

    /* === BARRE DE NAVIGATION STYLIS√âE === */
    .nav-container {
      background: #0066FF;
      padding: 8px;
      border-radius: 50px;
      margin: 20px auto 30px;
      max-width: 600px;
      box-shadow: 0 10px 40px rgba(0,102,255,0.3);
      border: 3px solid #0055DD;
    }

    .bottom-nav {
      display: flex;
      justify-content: center;
      gap: 5px;
      padding: 5px;
    }

    .bottom-nav a {
      flex: 1;
      text-align: center;
      padding: 16px 25px;
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1rem;
      border-radius: 40px;
      transition: all 0.3s ease;
      background: transparent;
      border: 2px solid transparent;
    }

    .bottom-nav a:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }

    .bottom-nav a.active {
      background: white;
      color: #0066FF;
      box-shadow: 0 6px 20px rgba(0,102,255,0.4);
      border: 2px solid #0055DD;
    }

    /* === ZONE DE RECHERCHE === */
    .search-container {
      text-align: center;
      padding: 40px 20px 30px;
    }

    .search-container h1 {
      color: #0066FF;
      font-size: 2rem;
      margin-bottom: 30px;
      font-weight: 700;
    }

    #searchInput {
      width: 92%;
      max-width: 700px;
      padding: 22px 35px;
      font-size: 1.6rem;
      border: 6px solid #0066FF;
      border-radius: 50px;
      outline: none;
      box-shadow: 0 15px 45px rgba(0,102,255,0.25);
      transition: all 0.3s ease;
    }

    #searchInput:focus {
      box-shadow: 0 20px 60px rgba(0,102,255,0.4);
      transform: translateY(-2px);
    }

    /* === INDICATEURS === */
    #status {
      margin: 25px 0;
      font-size: 1.3rem;
      color: #0066FF;
      font-weight: bold;
    }

    #resultCount {
      margin: 25px 0;
      font-size: 1.5rem;
      color: #0066FF;
      font-weight: bold;
      padding: 12px 25px;
      background: rgba(0,102,255,0.1);
      border-radius: 30px;
      display: inline-block;
    }

    /* === GRILLE DE R√âSULTATS === */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 30px;
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .result-card {
      background: white;
      border: 5px solid #0066FF;
      border-radius: 24px;
      padding: 30px;
      text-align: left;
      box-shadow: 0 15px 45px rgba(0,102,255,0.15);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }

    .result-card:hover {
      transform: translateY(-15px) scale(1.02);
      box-shadow: 0 30px 70px rgba(0,102,255,0.3);
    }

    .score-badge {
      position: absolute;
      top: -12px;
      right: 15px;
      background: linear-gradient(135deg, #0066FF, #0044CC);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      box-shadow: 0 5px 15px rgba(0,102,255,0.3);
    }

    .file-title {
      font-weight: bold;
      font-size: 1.5rem;
      color: #0066FF;
      margin-bottom: 15px;
      line-height: 1.3;
    }

    .snippet {
      background: #f8fbff;
      padding: 20px;
      border-radius: 15px;
      margin: 18px 0;
      line-height: 1.7;
      font-size: 1.1rem;
      border-left: 4px solid #0066FF;
    }

    .highlight {
      background: linear-gradient(120deg, #ffeb3b, #ffc107);
      color: #000;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .download-btn {
      background: linear-gradient(135deg, #0066FF, #0044CC);
      color: white;
      padding: 16px 45px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      margin-top: 15px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      box-shadow: 0 8px 25px rgba(0,102,255,0.3);
    }

    .download-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0,102,255,0.5);
    }

    /* === INDICATEUR DE CHARGEMENT === */
    .loading {
      text-align: center;
      padding: 60px 20px;
      grid-column: 1 / -1;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #0066FF;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* === PAGINATION === */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 40px 0;
      padding: 0 20px;
    }

    .page-btn {
      padding: 12px 20px;
      background: white;
      border: 3px solid #0066FF;
      border-radius: 15px;
      color: #0066FF;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .page-btn:hover {
      background: #0066FF;
      color: white;
      transform: translateY(-2px);
    }

    .page-btn.active {
      background: #0066FF;
      color: white;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .logo-text {
        font-size: 1.8rem;
      }
      
      .logo-container {
        padding: 12px 30px;
      }
      
      .nav-container {
        margin: 15px 20px;
      }
      
      .bottom-nav a {
        padding: 14px 15px;
        font-size: 1rem;
      }
      
      .results-grid {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px;
      }
      
      #searchInput {
        font-size: 1.3rem;
        padding: 18px 25px;
      }
      
      .search-container h1 {
        font-size: 1.6rem;
      }
    }

    /* === ANIMATIONS === */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-card {
      animation: fadeIn 0.6s ease-out;
    }
  </style>
</head>
<body>

  <!-- LOGO CENTR√â EN HAUT -->
  <div class="header-center">
    <div class="logo-container">
      <img src="logo.png" alt="Megane Learn" class="logo-header">
      <span class="logo-text">Megane Learn</span>
    </div>
  </div>

  <!-- BARRE DE NAVIGATION STYLIS√âE -->
  <div class="nav-container">
    <nav class="bottom-nav">
      <a href="index.html">ACCUEIL</a>
      <a href="rech.html" class="active">RECHERCHE</a>
      <a href="bt.html">PRO</a>
      <a href="gd.html">GUIDE</a>
    </nav>
  </div>

  <!-- ZONE DE RECHERCHE -->
  <div class="search-container">
    <h1>√âcrivez un mot cl√© pour voir les PDF disponibles</h1>
    <input type="text" id="searchInput" placeholder="Ex : cours de math primitive, frein ABS, sch√©ma √©lectrique..." autofocus>
    <div id="status">Chargement des PDF depuis searchfiles/...</div>
    <div id="resultCount"></div>
  </div>

  <!-- R√âSULTATS -->
  <div class="results-grid" id="results"></div>

  <!-- PAGINATION -->
  <div class="pagination" id="pagination" style="display: none;"></div>

  <script type="module">
    const RECH_FOLDER = "searchfiles";
    let allPDFs = [];
    let pdfCache = new Map();
    let searchTimeout;
    let currentPage = 1;
    const resultsPerPage = 12;
    let currentResults = [];

    // Cache des PDF analys√©s
    async function getPDFText(pdfName) {
      if (pdfCache.has(pdfName)) {
        return pdfCache.get(pdfName);
      }
      
      let fullText = "";
      try {
        const loadingTask = pdfjsLib.getDocument(`https://raw.githubusercontent.com/ivanipote/PDF-search/main/${RECH_FOLDER}/${pdfName}`);
        const doc = await loadingTask.promise;
        for (let p = 1; p <= Math.min(doc.numPages, 10); p++) {
          const page = await doc.getPage(p);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(i => i.str).join(" ");
          fullText += pageText + " ";
        }
        pdfCache.set(pdfName, fullText);
      } catch (e) {
        console.error("Erreur analyse PDF:", pdfName, e);
      }
      return fullText;
    }

    // Recherche avec d√©lai (debounce)
    function setupSearchDebounce() {
      document.getElementById("searchInput").addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        showLoading();
        
        searchTimeout = setTimeout(() => {
          const query = e.target.value.trim();
          if (query.length < 2) {
            showAllPDFs();
          } else {
            currentPage = 1;
            search(query);
          }
        }, 300);
      });
    }

    // Indicateur de chargement
    function showLoading() {
      document.getElementById("results").innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Recherche en cours...</p>
        </div>
      `;
      document.getElementById("pagination").style.display = 'none';
    }

    // Pagination
    function displayPaginatedResults(results) {
      const start = (currentPage - 1) * resultsPerPage;
      const end = start + resultsPerPage;
      const paginatedResults = results.slice(start, end);
      
      displayResults(paginatedResults);
      setupPagination(results.length);
    }

    function setupPagination(totalResults) {
      const totalPages = Math.ceil(totalResults / resultsPerPage);
      const paginationDiv = document.getElementById("pagination");
      
      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }
      
      paginationDiv.style.display = 'flex';
      paginationDiv.innerHTML = '';
      
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        btn.textContent = i;
        btn.onclick = () => {
          currentPage = i;
          displayPaginatedResults(currentResults);
        };
        paginationDiv.appendChild(btn);
      }
    }

    // Recherche s√©mantique simple
    const synonymes = {
      "maths": ["math√©matiques", "calcul", "alg√®bre"],
      "electronique": ["circuit", "composant", "sch√©ma"],
      "physique": ["m√©canique", "optique", "thermodynamique"]
    };

    function expandQuery(query) {
      const terms = query.toLowerCase().split(/\s+/);
      const expanded = [...terms];
      terms.forEach(term => {
        if (synonymes[term]) {
          expanded.push(...synonymes[term]);
        }
      });
      return [...new Set(expanded)];
    }

    // Fonctions existantes avec am√©liorations
    async function loadPDFList() {
      try {
        showLoading();
        const resp = await fetch(`https://api.github.com/repos/ivanipote/PDF-search/contents/${RECH_FOLDER}`);
        const files = await resp.json();
        allPDFs = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
        
        // Pr√©charge les m√©tadonn√©es des premiers PDF
        setTimeout(() => preloadPDFMetadata(), 1000);
        
        document.getElementById("status").textContent = `${allPDFs.length} connexion r√©ussie - tapez plusieurs mots pour une recherche intelligente !`;
        showAllPDFs();
      } catch (e) {
        document.getElementById("status").textContent = "Erreur : dossier searchfiles introuvable";
      }
    }

    async function preloadPDFMetadata() {
      const limitedPDFs = allPDFs.slice(0, 20);
      limitedPDFs.forEach(pdf => {
        getPDFText(pdf.name);
      });
    }

    function highlightText(text, terms) {
      let highlighted = text;
      terms.forEach(term => {
        const regex = new RegExp(`(${term})`, 'gi');
        highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
      });
      return highlighted;
    }

    function calculateScore(pdfName, pdfText, terms) {
      let score = 0;
      const lowerName = pdfName.toLowerCase();
      const lowerText = pdfText.toLowerCase();
      
      terms.forEach(term => {
        if (lowerName.includes(term)) score += 3;
        const matches = (lowerText.match(new RegExp(term, 'gi')) || []).length;
        score += matches;
      });
      
      return score;
    }

    async function search(query) {
      const baseTerms = query.toLowerCase().split(/\s+/).filter(t => t.length > 1);
      const expandedTerms = expandQuery(query);
      
      let results = [];

      for (const pdf of allPDFs) {
        let snippet = "";
        let fullText = "";

        // Recherche dans le nom
        const nameMatchCount = baseTerms.filter(t => pdf.name.toLowerCase().includes(t)).length;

        // Recherche dans le contenu
        try {
          fullText = await getPDFText(pdf.name);
          if (!snippet && fullText) {
            for (const term of baseTerms) {
              const index = fullText.toLowerCase().indexOf(term);
              if (index !== -1) {
                snippet = fullText.substring(Math.max(0, index - 50), index + 200) + "...";
                break;
              }
            }
          }
        } catch (e) {}

        const score = calculateScore(pdf.name, fullText, expandedTerms);
        if (score > 0 || nameMatchCount > 0) {
          results.push({
            pdf,
            score,
            snippet: snippet || "Correspondance trouv√©e dans le nom du fichier",
            terms: baseTerms
          });
        }
      }

      results.sort((a, b) => b.score - a.score);
      currentResults = results;
      displayPaginatedResults(results);
      
      document.getElementById("resultCount").textContent = 
        `${results.length} r√©sultat${results.length > 1 ? 's' : ''} intelligent${results.length > 1 ? 's' : ''}`;
    }

    function displayResults(results) {
      const grid = document.getElementById("results");
      grid.innerHTML = "";

      if (results.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
            <h2 style="color: #0066FF;">Aucun r√©sultat trouv√©</h2>
            <p>Essayez avec d'autres mots-cl√©s ou v√©rifiez l'orthographe</p>
          </div>
        `;
        return;
      }

      results.forEach(item => {
        const rawUrl = `https://raw.githubusercontent.com/ivanipote/PDF-search/main/${RECH_FOLDER}/${item.pdf.name}`;
        const card = document.createElement("div");
        card.className = "result-card";
        card.innerHTML = `
          <div class="score-badge">Score ${item.score}</div>
          <div class="file-title">üìÑ ${item.pdf.name}</div>
          <div class="snippet">${highlightText(item.snippet, item.terms)}</div>
          <a href="${rawUrl}" download class="download-btn">T√©l√©charger le PDF</a>
        `;
        grid.appendChild(card);
      });
    }

    function showAllPDFs() {
      currentResults = allPDFs;
      displayPaginatedResults(allPDFs);
      document.getElementById("resultCount").textContent = `${allPDFs.length} PDF disponibles`;
    }

    // Mode hors-ligne basique
    function savePDFListLocally(pdfs) {
      localStorage.setItem('pdfList', JSON.stringify(pdfs));
      localStorage.setItem('pdfListTimestamp', Date.now());
    }

    function loadPDFListLocally() {
      const saved = localStorage.getItem('pdfList');
      const timestamp = localStorage.getItem('pdfListTimestamp');
      
      if (saved && timestamp && (Date.now() - timestamp < 24 * 60 * 60 * 1000)) {
        return JSON.parse(saved);
      }
      return null;
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      setupSearchDebounce();
      
      const cachedPDFs = loadPDFListLocally();
      if (cachedPDFs) {
        allPDFs = cachedPDFs;
        document.getElementById("status").textContent = `${allPDFs.length} PDF charg√©s depuis le cache`;
        showAllPDFs();
      }
      
      loadPDFList();
    });
  </script>

  <script src="script.js"></script>
</body>
  </html>
